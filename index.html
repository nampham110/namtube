<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let transcriptData = [];

function getVideoID(url) {
  const regExp = /(?:v=|youtu\.be\/)([^&]+)/;
  const match = url.match(regExp);
  return match ? match[1] : null;
}

function loadVideo() {
  const link = document.getElementById("ytlink").value;
  const id = getVideoID(link);

  fetch(`/transcript?id=${id}`)
    .then(res => res.json())
    .then(response => {

      if (response.error) {
        alert("Video không có phụ đề công khai.");
        return;
      }

      transcriptData = response.data;
      renderTranscript();
    });

  player = new YT.Player('player', {
    height: '300',
    width: '100%',
    videoId: id,
    events: {
      'onReady': onPlayerReady
    }
  });
}

function onPlayerReady() {
  setInterval(syncSubtitle, 500);
}

function renderTranscript() {
  const container = document.getElementById("subtitles");
  container.innerHTML = "";

  transcriptData.forEach((line, index) => {
    const div = document.createElement("div");
    div.id = "line-" + index;
    div.innerHTML = `
      <b>${line.original}</b><br>
      <span style="color:gray">${line.translated}</span><hr>
    `;
    container.appendChild(div);
  });
}

function syncSubtitle() {
  if (!player || !player.getCurrentTime) return;

  const currentTime = player.getCurrentTime();

  transcriptData.forEach((line, index) => {
    const element = document.getElementById("line-" + index);

    if (
      currentTime >= line.start &&
      currentTime <= line.start + line.duration
    ) {
      element.style.background = "#ffe58a";
      element.scrollIntoView({behavior: "smooth", block: "center"});
    } else {
      element.style.background = "transparent";
    }
  });
}
</script>
