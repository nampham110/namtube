<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NamTube Translator</title>
<style>
body { font-family: Arial; padding: 20px; }
#subtitles div { padding: 10px; margin-bottom: 5px; }
</style>
</head>
<body>

<h2>NamTube Translator</h2>

<input id="ytlink" placeholder="Dán link YouTube ở đây" style="width:60%;">
<button onclick="loadVideo()">Load</button>

<div id="player" style="margin-top:20px;"></div>

<h3>Phụ đề song ngữ</h3>
<div id="subtitles"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let transcriptData = [];

function getVideoID(url) {
  const regExp = /(?:v=|youtu\.be\/)([^&]+)/;
  const match = url.match(regExp);
  return match ? match[1] : null;
}

function loadVideo() {
  const link = document.getElementById("ytlink").value;
  const id = getVideoID(link);

  if (!id) {
    alert("Link không hợp lệ");
    return;
  }

  fetch(`/transcript?id=${id}`)
    .then(res => res.json())
    .then(data => {

      if (data.error) {
        alert("Video không có phụ đề.");
        return;
      }

      transcriptData = data;
      renderTranscript();
    });

  player = new YT.Player('player', {
    height: '360',
    width: '100%',
    videoId: id,
    events: {
      'onReady': onPlayerReady
    }
  });
}

function onPlayerReady() {
  setInterval(syncSubtitle, 500);
}

function renderTranscript() {
  const container = document.getElementById("subtitles");
  container.innerHTML = "";

  transcriptData.forEach((line, index) => {
    const div = document.createElement("div");
    div.id = "line-" + index;
    div.innerHTML = `
      <b>${line.original}</b><br>
      <span style="color:gray">${line.translated}</span>
    `;
    container.appendChild(div);
  });
}

function syncSubtitle() {
  if (!player || !player.getCurrentTime) return;

  const currentTime = player.getCurrentTime();

  transcriptData.forEach((line, index) => {
    const element = document.getElementById("line-" + index);

    if (
      currentTime >= line.start &&
      currentTime <= line.start + line.duration
    ) {
      element.style.background = "#ffe58a";
      element.scrollIntoView({behavior: "smooth", block: "center"});
    } else {
      element.style.background = "transparent";
    }
  });
}
</script>

</body>
</html>
